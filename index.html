<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>棋牌室点单系统</title>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:#111; color:#eee; margin:0; padding:16px; }
    h1,h2 { margin-top:0; }
    .card { background:#1e1e1e; border-radius:8px; padding:16px; margin-bottom:16px; }
    button { padding:8px 12px; margin:4px; border-radius:6px; border:none; background:#2d7cff; color:white; font-size:14px; }
    button.secondary { background:#555; }
    button.danger { background:#c0392b; }
    button:disabled { opacity:0.5; }
    .row { display:flex; justify-content:space-between; align-items:center; margin:6px 0; }
    .muted { color:#aaa; font-size:12px; }
    input { padding:6px; border-radius:4px; border:none; }
  </style>
</head>
<body>

<script>
/**********************
 * 1. 核心配置（唯一真相源）
 **********************/
const CONFIG = {
  ROOMS: ["A1", "A2", "B1", "B2"],
  BASE_PRICE: 120,
  BASE_HOURS: 4,
  OVER_TIME_PRICE: 30,
  PRODUCTS: [
    { id: "cola", name: "可乐", price: 5 },
    { id: "water", name: "矿泉水", price: 3 },
    { id: "snack", name: "零食", price: 10 }
  ]
};

/**********************
 * 2. 存储层（只服务老板端）
 **********************/
const STORAGE = {
  status(room) {
    return JSON.parse(localStorage.getItem(`room_status_${room}`));
  },
  saveStatus(room, data) {
    localStorage.setItem(`room_status_${room}`, JSON.stringify(data));
  },
  clearStatus(room) {
    localStorage.removeItem(`room_status_${room}`);
  },
  orders(room) {
    return JSON.parse(localStorage.getItem(`orders_${room}`)) || [];
  },
  saveOrders(room, orders) {
    localStorage.setItem(`orders_${room}`, JSON.stringify(orders));
  }
};

/**********************
 * 3. 业务层（纯逻辑，无 DOM）
 **********************/
const Service = {
  openRoom(room) {
    if (STORAGE.status(room)) return false;
    STORAGE.saveStatus(room, { room, startTime: Date.now(), items: [] });
    STORAGE.saveOrders(room, []);
    return true;
  },

  addItem(room, productId) {
    const status = STORAGE.status(room);
    if (!status) return;
    const product = CONFIG.PRODUCTS.find(p => p.id === productId);
    status.items.push({ ...product, time: Date.now() });
    STORAGE.saveStatus(room, status);
  },

  calcTotal(room) {
    const status = STORAGE.status(room);
    if (!status) return 0;

    const now = Date.now();
    const hours = (now - status.startTime) / 3600000;
    const overtime = Math.max(0, hours - CONFIG.BASE_HOURS);

    const timeFee = CONFIG.BASE_PRICE + Math.ceil(overtime) * CONFIG.OVER_TIME_PRICE;
    const productFee = status.items.reduce((s, i) => s + i.price, 0);

    return { timeFee, productFee, total: timeFee + productFee };
  },

  checkout(room) {
    const bill = Service.calcTotal(room);
    STORAGE.clearStatus(room);
    return bill;
  }
};

/**********************
 * 4. 路由（老板 / 客户）
 **********************/
const params = new URLSearchParams(location.search);
const room = params.get("room");
const role = params.get("role");

if (!room || !CONFIG.ROOMS.includes(room)) {
  document.body.innerHTML = "<h2>无效房间</h2>";
} else if (role === "admin") {
  initAdmin(room);
} else {
  initClient(room);
}

/**********************
 * 5. 客户端（只做 UI，不写状态）
 **********************/
function initClient(room) {
  const status = STORAGE.status(room);
  document.body.innerHTML = `<h1>包厢 ${room}</h1>`;

  if (!status) {
    document.body.innerHTML += `<p class='muted'>包厢尚未开台，请联系老板</p>`;
    return;
  }

  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML = `<h2>点单</h2>`;

  CONFIG.PRODUCTS.forEach(p => {
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `<span>${p.name} ¥${p.price}</span>`;
    const btn = document.createElement("button");
    btn.textContent = "添加";
    btn.onclick = () => {
      // 关键：客户端不直接写老板数据
      alert("已通知老板加单：" + p.name);
    };
    row.appendChild(btn);
    card.appendChild(row);
  });

  document.body.appendChild(card);
}

/**********************
 * 6. 老板端（唯一写数据者）
 **********************/
function initAdmin(room) {
  document.body.innerHTML = `<h1>老板端 - 包厢 ${room}</h1>`;

  const wrap = document.createElement("div");

  const status = STORAGE.status(room);

  if (!status) {
    const openBtn = document.createElement("button");
    openBtn.textContent = "开台";
    openBtn.onclick = () => { Service.openRoom(room); location.reload(); };
    wrap.appendChild(openBtn);
    document.body.appendChild(wrap);
    return;
  }

  const bill = Service.calcTotal(room);

  const info = document.createElement("div");
  info.className = "card";
  info.innerHTML = `
    <h2>当前消费</h2>
    <p>时间费用：¥${bill.timeFee}</p>
    <p>商品费用：¥${bill.productFee}</p>
    <h3>合计：¥${bill.total}</h3>
  `;

  const products = document.createElement("div");
  products.className = "card";
  products.innerHTML = `<h2>加商品</h2>`;

  CONFIG.PRODUCTS.forEach(p => {
    const btn = document.createElement("button");
    btn.textContent = p.name;
    btn.onclick = () => { Service.addItem(room, p.id); location.reload(); };
    products.appendChild(btn);
  });

  const actions = document.createElement("div");
  actions.className = "card";

  const checkoutBtn = document.createElement("button");
  checkoutBtn.className = "danger";
  checkoutBtn.textContent = "结账";
  checkoutBtn.onclick = () => {
    const b = Service.checkout(room);
    alert(`结账完成：¥${b.total}`);
    location.reload();
  };

  const cancelBtn = document.createElement("button");
  cancelBtn.className = "secondary";
  cancelBtn.textContent = "撤销";
  cancelBtn.onclick = () => { STORAGE.clearStatus(room); location.reload(); };

  actions.appendChild(checkoutBtn);
  actions.appendChild(cancelBtn);

  wrap.appendChild(info);
  wrap.appendChild(products);
  wrap.appendChild(actions);

  document.body.appendChild(wrap);
}
</script>

</body>
</html>
