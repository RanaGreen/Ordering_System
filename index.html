<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>棋牌室计时 + 点单系统</title>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI";
  background: #111;
  color: #eee;
}

.container { padding: 16px; }
.hidden { display: none; }

.card {
  background: #1e1e1e;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 14px;
}

h1, h2, h3 { margin: 10px 0; }

.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 6px 0;
}

input, select {
  width: 120px;
  padding: 6px;
  border-radius: 6px;
  border: none;
}

button {
  padding: 8px 12px;
  border-radius: 6px;
  border: none;
  background: #3a8bfd;
  color: #fff;
}

button.secondary { background: #555; }
button.danger { background: #c0392b; }

.room-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}

.room-btn {
  padding: 14px;
  background: #333;
  border-radius: 8px;
  text-align: center;
}

.room-btn.active {
  background: #3a8bfd;
  cursor: pointer;
}
</style>
</head>

<body>
<div class="container">

<!-- ===== 老板端 ===== -->
<div id="adminView" class="hidden">
  <h1>老板端 · 棋牌室管理</h1>

  <div class="card">
    <h2>开台</h2>
    <div class="row"><span>当前时间</span><span id="nowTime"></span></div>
    <div class="row"><span>包厢号</span><select id="roomSel"></select></div>
    <div class="row"><span>包厢类型</span>
      <select id="typeSel">
        <option value="small">小包</option>
        <option value="medium">中包</option>
        <option value="large">大包</option>
      </select>
    </div>
    <div class="row"><span>基础价格</span><input id="basePrice"/></div>
    <div class="row"><span>基础时长(h)</span><input id="baseHours" value="5"/></div>
    <div class="row"><span>超时费(/h)</span><input id="overPrice" value="20"/></div>
    <div class="row">
      <span>费用减免</span>
      <select id="discount">
        <option value="0">无</option>
        <option value="10">减10</option>
        <option value="20">减20</option>
      </select>
    </div>
    <div class="row">
      <span>支付方式</span>
      <select id="pay">
        <option>微信</option>
        <option>支付宝</option>
        <option>美团</option>
      </select>
    </div>
    <button onclick="openRoom()">确认开台</button>
  </div>

  <div class="card">
    <h2>包厢一览</h2>
    <div class="room-grid" id="roomGrid"></div>
  </div>

  <div id="detail"></div>
</div>

<!-- ===== 客户端（仅兜底显示，不做业务） ===== -->
<div id="clientView" class="hidden">
  <h1>包厢 <span id="clientRoom"></span></h1>
  <div class="card">
    <p>客户端入口已生效</p>
    <p>当前包厢号：<span id="clientRoom2"></span></p>
  </div>
</div>

</div>

<script>
const ROOM_TYPES = {
  small: 40,
  medium: 70,
  large: 90
};

const DB = {
  active: () => JSON.parse(localStorage.getItem("active") || "{}"),
  saveActive: d => localStorage.setItem("active", JSON.stringify(d)),
  history: () => JSON.parse(localStorage.getItem("history") || "[]"),
  saveHistory: h => localStorage.setItem("history", JSON.stringify(h))
};

const params = new URLSearchParams(location.search);
const roomParam = params.get("room");
const roleParam = params.get("role");

if (roleParam === "admin") {
  initAdmin();
} else if (roomParam) {
  initClient(roomParam);
}

function initClient(room) {
  document.getElementById("clientView").classList.remove("hidden");
  document.getElementById("clientRoom").innerText = room;
  document.getElementById("clientRoom2").innerText = room;
}

/* ===== 老板端原逻辑，未改动 ===== */

function initAdmin() {
  document.getElementById("adminView").classList.remove("hidden");

  setInterval(() => {
    document.getElementById("nowTime").innerText =
      new Date().toLocaleString();
  }, 1000);

  const roomSel = document.getElementById("roomSel");
  for (let i = 1; i <= 16; i++) {
    const o = document.createElement("option");
    o.value = i;
    o.textContent = i;
    roomSel.appendChild(o);
  }

  document.getElementById("typeSel").onchange = e => {
    document.getElementById("basePrice").value =
      ROOM_TYPES[e.target.value];
  };
  document.getElementById("typeSel").dispatchEvent(new Event("change"));

  renderRooms();
}

function openRoom() {
  const active = DB.active();
  const room = document.getElementById("roomSel").value;
  if (active[room]) return;

  active[room] = {
    room,
    type: typeSel.value,
    basePrice: +basePrice.value,
    baseHours: +baseHours.value,
    overPrice: +overPrice.value,
    discount: +discount.value,
    pay: pay.value,
    start: Date.now(),
    products: []
  };

  DB.saveActive(active);
  renderRooms();
}

function renderRooms() {
  const grid = document.getElementById("roomGrid");
  grid.innerHTML = "";
  const active = DB.active();

  for (let i = 1; i <= 16; i++) {
    const btn = document.createElement("div");
    btn.className = "room-btn";
    btn.innerText = "包厢 " + i;
    if (active[i]) {
      btn.classList.add("active");
      btn.onclick = () => showDetail(i);
    }
    grid.appendChild(btn);
  }
}

function showDetail(room) {
  const order = DB.active()[room];
  const now = Date.now();
  const used = (now - order.start) / 3600000;
  const overtime = Math.max(0, Math.ceil(used - order.baseHours));
  const roomFee = order.basePrice + overtime * order.overPrice - order.discount;

  const div = document.getElementById("detail");
  div.innerHTML = `
    <div class="card">
      <h2>包厢 ${room}</h2>
      <p>开台时间：${new Date(order.start).toLocaleString()}</p>
      <p>已用时长：${used.toFixed(2)} h</p>
      <p>超时：${overtime} h</p>
      <p>包厢费用：¥${roomFee}</p>
      <button onclick="closeRoom(${room}, true)">收工</button>
      <button class="secondary" onclick="closeRoom(${room}, false)">撤销</button>
    </div>
  `;
}

function closeRoom(room, paid) {
  const active = DB.active();
  const order = active[room];
  delete active[room];

  const history = DB.history();
  history.push({ ...order, end: Date.now(), paid });
  DB.saveHistory(history);
  DB.saveActive(active);

  renderRooms();
  document.getElementById("detail").innerHTML = "";
}
</script>
</body>
</html>
