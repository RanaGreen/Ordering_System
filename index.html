<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>棋牌室计时＋点单系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      background: #111;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
    }
    h1, h2, h3 { margin: 0.5em 0; }
    button {
      padding: 8px 12px;
      margin: 4px;
      background: #2d8cf0;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button.secondary { background: #666; }
    button.danger { background: #c0392b; }
    .container { padding: 16px; }
    .card {
      border: 1px solid #333;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
      background: #1c1c1c;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .room-btn {
      padding: 12px;
      background: #333;
    }
    .room-btn.active {
      background: #27ae60;
    }
    .muted {
      color: #aaa;
      font-size: 14px;
    }
    input, select {
      width: 100%;
      padding: 6px;
      margin-top: 4px;
      background: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
    }
  </style>
</head>
<body>
<div id="app"></div>

<script>
/* =======================
   全局基础配置
======================= */

const ROOMS = Array.from({ length: 16 }, (_, i) => String(i + 1))
const ROOM_TYPES = {
  small: { name: '小包', price: 40 },
  mid: { name: '中包', price: 70 },
  large: { name: '大包', price: 90 }
}
const EXTRA_PER_HOUR = 20

/* =======================
   模拟“服务器状态”
   （未来上云后整体替换）
======================= */

const Store = {
  rooms: {}, // roomId -> order
}

function now() {
  return new Date().toLocaleString()
}

/* =======================
   路由判断
======================= */

const params = new URLSearchParams(location.search)
const role = params.get('role')
const room = params.get('room')

const app = document.getElementById('app')

if (role === 'admin') {
  renderAdmin()
} else if (room) {
  renderClient(room)
} else {
  renderEntry()
}

/* =======================
   入口页
======================= */

function renderEntry() {
  app.innerHTML = `
    <div class="container">
      <h1>棋牌室计时＋点单系统</h1>
      <div class="card">
        <p>老板端：</p>
        <code>?role=admin</code>
      </div>
      <div class="card">
        <p>客户端：</p>
        <code>?room=1 ~ 16</code>
      </div>
      <p class="muted">当前为单文件演示版（GitHub Pages）</p>
    </div>
  `
}

/* =======================
   客户端
======================= */

function renderClient(roomId) {
  if (!ROOMS.includes(roomId)) {
    app.innerHTML = `<div class="container"><h2>非法包厢号</h2></div>`
    return
  }

  const goods = [
    { name: '矿泉水', price: 5 },
    { name: '可乐', price: 6 },
    { name: '红牛', price: 8 },
  ]

  let cart = {}

  function render() {
    app.innerHTML = `
      <div class="container">
        <h2>包厢 ${roomId} 点单</h2>
        ${goods.map(g => `
          <div class="card">
            ${g.name} ￥${g.price}
            <button onclick="add('${g.name}', ${g.price})">＋</button>
            <button class="secondary" onclick="sub('${g.name}')">－</button>
            <span> ${cart[g.name]?.qty || 0}</span>
          </div>
        `).join('')}
        <button onclick="submit()">提交点单</button>
      </div>
    `
  }

  window.add = (name, price) => {
    cart[name] = cart[name] || { price, qty: 0 }
    cart[name].qty++
    render()
  }

  window.sub = (name) => {
    if (cart[name]) {
      cart[name].qty--
      if (cart[name].qty <= 0) delete cart[name]
      render()
    }
  }

  window.submit = () => {
    if (!Store.rooms[roomId]) {
      alert('该包厢尚未开台')
      return
    }
    Store.rooms[roomId].orders.push({
      time: now(),
      items: JSON.parse(JSON.stringify(cart))
    })
    cart = {}
    alert('点单已提交')
    render()
  }

  render()
}

/* =======================
   老板端
======================= */

function renderAdmin() {
  function render() {
    app.innerHTML = `
      <div class="container">
        <h1>老板端</h1>

        <div class="card">
          <h3>开台</h3>
          <label>包厢号
            <select id="roomSelect">
              ${ROOMS.map(r => `<option>${r}</option>`).join('')}
            </select>
          </label>
          <label>包厢类型
            <select id="typeSelect">
              ${Object.keys(ROOM_TYPES).map(k =>
                `<option value="${k}">${ROOM_TYPES[k].name}</option>`
              ).join('')}
            </select>
          </label>
          <button onclick="openRoom()">确认开台</button>
        </div>

        <div class="card">
          <h3>包厢一览</h3>
          <div class="grid">
            ${ROOMS.map(r => `
              <button class="room-btn ${Store.rooms[r] ? 'active' : ''}"
                onclick="viewRoom('${r}')">
                ${r}
              </button>
            `).join('')}
          </div>
        </div>

        <div id="detail"></div>
      </div>
    `
  }

  window.openRoom = () => {
    const roomId = document.getElementById('roomSelect').value
    const typeKey = document.getElementById('typeSelect').value
    if (Store.rooms[roomId]) {
      alert('该包厢已开台')
      return
    }
    Store.rooms[roomId] = {
      roomId,
      type: ROOM_TYPES[typeKey],
      start: now(),
      orders: []
    }
    render()
  }

  window.viewRoom = (roomId) => {
    const r = Store.rooms[roomId]
    if (!r) return
    const totalOrder = r.orders.reduce((sum, o) => {
      return sum + Object.values(o.items).reduce((s, i) => s + i.price * i.qty, 0)
    }, 0)

    document.getElementById('detail').innerHTML = `
      <div class="card">
        <h3>包厢 ${roomId}</h3>
        <p>开台时间：${r.start}</p>
        <p>基础价格：￥${r.type.price}</p>
        <p>点单金额：￥${totalOrder}</p>
        <p><b>合计：￥${r.type.price + totalOrder}</b></p>
        <button onclick="closeRoom('${roomId}')">收工</button>
        <button class="danger" onclick="cancelRoom('${roomId}')">撤销</button>
      </div>
    `
  }

  window.closeRoom = (roomId) => {
    delete Store.rooms[roomId]
    document.getElementById('detail').innerHTML = ''
    render()
  }

  window.cancelRoom = window.closeRoom

  render()
}
</script>
</body>
</html>