<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>九易点单系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      background: #f5f5f5;
      margin: 0;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      background: #ffffff;
      min-height: 100vh;
      padding: 16px;
      box-sizing: border-box;
    }

    .title {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .admin-title {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #409eff;
    }

    .room {
      background: #e6f2ff;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 16px;
    }

    .admin-room {
      background: #e6f7ed;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 16px;
      color: #67c23a;
    }

    .section-title {
      font-size: 18px;
      margin: 16px 0 8px;
      font-weight: bold;
    }

    .admin-section-title {
      font-size: 18px;
      margin: 16px 0 8px;
      font-weight: bold;
      color: #409eff;
      border-left: 4px solid #409eff;
      padding-left: 8px;
    }

    .item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .item button {
      background: #409eff;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
    }

    .order {
      background: #fafafa;
      padding: 10px;
      border-radius: 6px;
      margin-top: 16px;
    }

    .admin-order {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      border-left: 4px solid #409eff;
    }

    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .admin-order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .controls button {
      margin-left: 6px;
      padding: 2px 8px;
      font-size: 14px;
    }

    .total {
      font-weight: bold;
      margin-top: 10px;
      text-align: right;
    }

    .admin-total {
      font-weight: bold;
      margin-top: 10px;
      text-align: right;
      color: #409eff;
      font-size: 16px;
    }

    .submit-btn {
      background: #67c23a;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      width: 100%;
      margin-top: 20px;
      cursor: pointer;
    }

    .submit-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .admin-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .admin-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-paid {
      background: #67c23a;
      color: white;
    }

    .btn-cancel {
      background: #f56c6c;
      color: white;
    }

    .btn-refresh {
      background: #409eff;
      color: white;
    }

    .empty-orders {
      text-align: center;
      padding: 40px 20px;
      color: #999;
      font-size: 16px;
    }

    .order-status {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 8px;
    }

    .status-unpaid {
      background: #fef0f0;
      color: #f56c6c;
    }

    .status-paid {
      background: #f0f9eb;
      color: #67c23a;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }

    .order-time {
      font-size: 12px;
      color: #999;
    }
  </style>
</head>

<body>
<div class="container" id="container">
  <!-- 内容将由JavaScript动态生成 -->
</div>

<script>
  // 读取URL参数
  const params = new URLSearchParams(window.location.search);
  const room = params.get("room");
  const role = params.get("role");
  
  // 16个有效包厢
  const validRooms = [
    "V111", "V222", "V333", "V04", "V555", "V666", "V777", "V888",
    "V999", "V10", "U1", "U2", "U3", "U5", "U6", "U7"
  ];
  
  const container = document.getElementById("container");
  const isAdmin = role === "admin";
  
  if (isAdmin) {
    // 老板端
    initAdmin();
  } else {
    // 客户端
    initClient();
  }
  
  // 本地存储键名
  const STORAGE_KEY = "jiuyi_orders";
  
  // 获取所有订单
  function getAllOrders() {
    const ordersJson = localStorage.getItem(STORAGE_KEY);
    return ordersJson ? JSON.parse(ordersJson) : [];
  }
  
  // 保存订单
  function saveOrder(order) {
    const orders = getAllOrders();
    orders.push(order);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
  }
  
  // 更新订单状态
  function updateOrderStatus(orderId, status) {
    const orders = getAllOrders();
    const orderIndex = orders.findIndex(order => order.id === orderId);
    if (orderIndex !== -1) {
      orders[orderIndex].status = status;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(orders));
      return true;
    }
    return false;
  }
  
  // 客户端初始化
  function initClient() {
    // 检查包厢是否有效
    const isValidRoom = validRooms.includes(room);
    
    container.innerHTML = `
      <div class="title">九易点单系统</div>
      <div class="room" id="roomInfo">${isValidRoom ? `当前包厢：${room}` : '未识别包厢'}</div>
      
      <div class="section-title">商品列表</div>
      <div id="items"></div>
      
      <div class="section-title">当前订单</div>
      <div class="order" id="orderList">暂无商品</div>
      
      <div class="total" id="totalPrice">合计：0 元</div>
      
      <button class="submit-btn" id="submitBtn" ${!isValidRoom ? 'disabled' : ''}>下单</button>
    `;
    
    // 如果包厢无效，直接返回
    if (!isValidRoom) {
      return;
    }
    
    // 商品配置
    const products = [
      { id: 1, name: "可乐", price: 5 },
      { id: 2, name: "雪碧", price: 5 },
      { id: 3, name: "矿泉水", price: 3 },
      { id: 4, name: "泡面", price: 8 }
    ];
    
    // 当前订单
    let currentOrder = {};
    
    const itemsDiv = document.getElementById("items");
    const orderListDiv = document.getElementById("orderList");
    const totalPriceDiv = document.getElementById("totalPrice");
    const submitBtn = document.getElementById("submitBtn");
    
    // 生成商品列表
    products.forEach(p => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <span>${p.name}（${p.price} 元）</span>
        <button>加入</button>
      `;
      div.querySelector("button").onclick = () => addToOrder(p);
      itemsDiv.appendChild(div);
    });
    
    // 添加到订单
    function addToOrder(product) {
      if (!currentOrder[product.id]) {
        currentOrder[product.id] = { ...product, count: 1 };
      } else {
        currentOrder[product.id].count++;
      }
      renderOrder();
    }
    
    // 减少商品数量
    function removeFromOrder(productId) {
      if (!currentOrder[productId]) return;
      currentOrder[productId].count--;
      if (currentOrder[productId].count <= 0) {
        delete currentOrder[productId];
      }
      renderOrder();
    }
    
    // 渲染订单
    function renderOrder() {
      orderListDiv.innerHTML = "";
      let total = 0;
      let empty = true;
      
      for (const id in currentOrder) {
        empty = false;
        const item = currentOrder[id];
        const lineTotal = item.price * item.count;
        total += lineTotal;
        
        const div = document.createElement("div");
        div.className = "order-item";
        div.innerHTML = `
          <span>${item.name} × ${item.count}</span>
          <span class="controls">
            <button onclick="currentApp.sub(${id})">−</button>
          </span>
        `;
        orderListDiv.appendChild(div);
      }
      
      if (empty) {
        orderListDiv.innerText = "暂无商品";
        submitBtn.disabled = true;
      } else {
        submitBtn.disabled = false;
      }
      
      totalPriceDiv.innerText = `合计：${total} 元`;
    }
    
    // 下单功能
    submitBtn.onclick = function() {
      if (Object.keys(currentOrder).length === 0) {
        alert("请先添加商品");
        return;
      }
      
      // 生成订单数据
      const orderItems = [];
      let total = 0;
      
      for (const id in currentOrder) {
        const item = currentOrder[id];
        const lineTotal = item.price * item.count;
        total += lineTotal;
        orderItems.push({
          id: item.id,
          name: item.name,
          price: item.price,
          count: item.count
        });
      }
      
      const order = {
        id: Date.now(), // 使用时间戳作为订单ID
        room: room,
        items: orderItems,
        total: total,
        status: "unpaid", // unpaid, paid
        time: new Date().toLocaleString()
      };
      
      // 保存到本地存储
      saveOrder(order);
      
      // 清空当前订单
      currentOrder = {};
      renderOrder();
      
      alert("下单成功！老板端已收到订单");
    };
    
    // 暴露函数给全局
    window.currentApp = {
      sub: removeFromOrder
    };
  }
  
  // 老板端初始化
  function initAdmin() {
    container.innerHTML = `
      <div class="admin-title">九易点单系统 - 老板端</div>
      <div class="admin-room">老板管理面板 - 实时查看包厢订单</div>
      
      <div class="admin-section-title">待处理订单</div>
      <div id="ordersList" class="empty-orders">暂无待处理订单</div>
      
      <div class="admin-section-title">今日总计</div>
      <div class="admin-total" id="adminTotal">今日总收入：0 元</div>
      
      <div class="admin-controls">
        <button class="admin-btn btn-refresh" onclick="refreshOrders()">刷新订单</button>
        <button class="admin-btn btn-secondary" onclick="window.location.href='?'">返回客户点单</button>
      </div>
    `;
    
    // 初始加载订单
    loadOrders();
    
    // 监听storage变化，实现实时更新
    window.addEventListener('storage', function(e) {
      if (e.key === STORAGE_KEY) {
        loadOrders();
      }
    });
  }
  
  // 加载订单
  function loadOrders() {
    const orders = getAllOrders();
    const ordersListDiv = document.getElementById("ordersList");
    const adminTotalDiv = document.getElementById("adminTotal");
    
    // 过滤未支付订单
    const unpaidOrders = orders.filter(order => order.status === "unpaid");
    const paidOrders = orders.filter(order => order.status === "paid");
    
    // 计算总收入
    let totalRevenue = 0;
    paidOrders.forEach(order => {
      totalRevenue += order.total;
    });
    
    // 显示订单
    if (unpaidOrders.length === 0) {
      ordersListDiv.innerHTML = '<div class="empty-orders">暂无待处理订单</div>';
    } else {
      ordersListDiv.innerHTML = '';
      unpaidOrders.forEach(order => {
        const orderDiv = document.createElement("div");
        orderDiv.className = "admin-order";
        orderDiv.id = `order-${order.id}`;
        
        // 订单头部
        const headerDiv = document.createElement("div");
        headerDiv.className = "order-header";
        headerDiv.innerHTML = `
          <strong>${order.room} 包厢</strong>
          <span class="order-time">${order.time}</span>
          <span class="order-status status-unpaid">待支付</span>
        `;
        
        // 商品列表
        const itemsDiv = document.createElement("div");
        itemsDiv.className = "admin-order-items";
        order.items.forEach(item => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "admin-order-item";
          itemDiv.innerHTML = `
            <span>${item.name}</span>
            <span>${item.count} × ${item.price}元 = ${item.count * item.price}元</span>
          `;
          itemsDiv.appendChild(itemDiv);
        });
        
        // 订单总计和控制按钮
        const totalDiv = document.createElement("div");
        totalDiv.className = "admin-total";
        totalDiv.innerHTML = `合计：${order.total} 元`;
        
        const controlsDiv = document.createElement("div");
        controlsDiv.className = "admin-controls";
        controlsDiv.innerHTML = `
          <button class="admin-btn btn-paid" onclick="markAsPaid('${order.id}')">已支付</button>
          <button class="admin-btn btn-cancel" onclick="deleteOrder('${order.id}')">删除</button>
        `;
        
        orderDiv.appendChild(headerDiv);
        orderDiv.appendChild(itemsDiv);
        orderDiv.appendChild(totalDiv);
        orderDiv.appendChild(controlsDiv);
        ordersListDiv.appendChild(orderDiv);
      });
    }
    
    // 更新总收入
    adminTotalDiv.textContent = `今日总收入：${totalRevenue} 元`;
  }
  
  // 标记为已支付
  function markAsPaid(orderId) {
    if (updateOrderStatus(orderId, "paid")) {
      loadOrders();
      alert("订单已标记为已支付");
    }
  }
  
  // 删除订单
  function deleteOrder(orderId) {
    if (confirm("确定要删除这个订单吗？")) {
      const orders = getAllOrders();
      const filteredOrders = orders.filter(order => order.id != orderId);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(filteredOrders));
      loadOrders();
    }
  }
  
  // 刷新订单
  function refreshOrders() {
    loadOrders();
    alert("订单已刷新");
  }
</script>
</body>
</html>